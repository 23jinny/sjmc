

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>6. Tallies &mdash; OpenMC Documentation</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.4.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="OpenMC Documentation" href="../index.html" />
    <link rel="up" title="Theory and Methodology" href="index.html" />
    <link rel="next" title="7. Parallelization" href="parallelization.html" />
    <link rel="prev" title="5. Physics" href="physics.html" /> 
  </head>
  <body>
      <div class="header">
        <a href="../index.html">
          <img class="logo" src="../_static/openmc.png" alt="Logo"/>
        </a>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="physics.html">5. Physics</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="parallelization.html">7. Parallelization</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="tallies">
<span id="methods-tallies"></span><h1>6. Tallies<a class="headerlink" href="#tallies" title="Permalink to this headline">¶</a></h1>
<div class="section" id="filters-and-scores">
<h2>6.1. Filters and Scores<a class="headerlink" href="#filters-and-scores" title="Permalink to this headline">¶</a></h2>
<p>The tally capability in OpenMC takes a similar philosophy as that employed in
the <a class="reference external" href="http://www.osti.gov/bridge/servlets/purl/903083-HT5p1o/903083.pdf">MC21</a> Monte Carlo code to give maximum flexibility in specifying tallies
while still maintaining scalability. Any tally in a Monte Carlo simulation can
be written in the following form:</p>
<div class="math" id="equation-tally-integral">
<p><span class="eqno">(1)</span><img src="../_images/math/6f7489fd2bc01b81438f2b62e88a6e3c39dde125.png" alt="X = \underbrace{\int d\mathbf{r} \int d\mathbf{\Omega} \int
dE}_{\text{filters}} \underbrace{f(\mathbf{r}, \mathbf{\Omega},
E)}_{\text{scores}} \psi (\mathbf{r}, \mathbf{\Omega}, E)"/></p>
</div><p>A user can specify one or more filters which identify which regions of phase
space should score to a given tally (the limits of integration as shown in
equation <a href="#equation-tally-integral">(1)</a>) as well as the scoring function (<img class="math" src="../_images/math/bb2c93730dbb48558bb3c4738c956c4e8f816437.png" alt="f"/> in
equation <a href="#equation-tally-integral">(1)</a>). For example, if the desired tally was the
<img class="math" src="../_images/math/3b5fe4c3b6f25cd9becd9e7f729b4d28bbd77c88.png" alt="(n,\gamma)"/> reaction rate in a fuel pin, the filter would specify the
cell which contains the fuel pin and the scoring function would be the radiative
capture macroscopic cross section. The following quantities can be scored in
OpenMC: flux, total reaction rate, scattering reaction rate, neutron production
from scattering, higher scattering moments, (n,xn) reaction rates, absorption
reaction rate, fission reaction rate, neutron production rate from fission, and
surface currents. The following variables can be used as filters: universe,
material, cell, birth cell, surface, mesh, pre-collision energy, and
post-collision energy.</p>
<p>With filters for pre- and post-collision energy and scoring functions for
scattering and fission production, it is possible to use OpenMC to generate
cross sections with user-defined group structures. These multigroup cross
sections can subsequently be used in deterministic solvers such as coarse-mesh
finite difference (CMFD) diffusion.</p>
</div>
<div class="section" id="using-maps-for-filter-matching">
<h2>6.2. Using Maps for Filter-Matching<a class="headerlink" href="#using-maps-for-filter-matching" title="Permalink to this headline">¶</a></h2>
<p>Some Monte Carlo codes suffer severe performance penalties when tallying a large
number of quantities. Care must be taken to ensure that a tally system scales
well with the total number of tally bins. In OpenMC, a mapping technique is used
that allows for a fast determination of what tally/bin combinations need to be
scored to a given particle&#8217;s phase space coordinates. For each discrete filter
variable, a list is stored that contains the tally/bin combinations that could
be scored to for each value of the filter variable. If a particle is in cell
<img class="math" src="../_images/math/174fadd07fd54c9afe288e96558c92e0c1da733a.png" alt="n"/>, the mapping would identify what tally/bin combinations specify cell
<img class="math" src="../_images/math/174fadd07fd54c9afe288e96558c92e0c1da733a.png" alt="n"/> for the cell filter variable. In this manner, it is not necessary to
check the phase space variables against each tally. Note that this technique
only applies to discrete filter variables and cannot be applied to energy
bins. For energy filters, it is necessary to perform a binary search on the
specified energy grid.</p>
</div>
<div class="section" id="volume-integrated-flux-and-reaction-rates">
<h2>6.3. Volume-Integrated Flux and Reaction Rates<a class="headerlink" href="#volume-integrated-flux-and-reaction-rates" title="Permalink to this headline">¶</a></h2>
<p>One quantity we may wish to compute during the course of a Monte Carlo
simulation is the flux or a reaction rate integrated over a finite volume. The
volume may be a particular cell, a collection of cells, or the entire
geometry. There are various methods by which we can estimate reaction rates</p>
<div class="section" id="analog-estimator">
<h3>6.3.1. Analog Estimator<a class="headerlink" href="#analog-estimator" title="Permalink to this headline">¶</a></h3>
<p>The analog estimator is the simplest type of estimator for reaction rates. The
basic idea is that we simply count the number of actual reactions that take
place and use that as our estimate for the reaction rate. This can be written
mathematically as</p>
<div class="math" id="equation-analog-estimator">
<p><span class="eqno">(2)</span><img src="../_images/math/5075b2fe167d0329008574cdb1a9e6d8cfdb6034.png" alt="R_x = \frac{1}{W} \sum_{i \in A} w_i"/></p>
</div><p>where <img class="math" src="../_images/math/e04fc1458c243800934b8d2d2419f4d38d7d2e50.png" alt="R_x"/> is the reaction rate for reaction <img class="math" src="../_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/>, <img class="math" src="../_images/math/34857b3ba74ce5cd8607f3ebd23e9015908ada71.png" alt="i"/> denotes
an index for each event, <img class="math" src="../_images/math/019e9892786e493964e145e7c5cf7b700314e53b.png" alt="A"/> is the set of all events resulting in
reaction <img class="math" src="../_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/>, and <img class="math" src="../_images/math/10cb764f88509fb1c8012366993fdbee98f31bc5.png" alt="W"/> is the total starting weight of the particles,
and <img class="math" src="../_images/math/535b2bfbb0a587e261a0d0af9b7b53e42629b14d.png" alt="w_i"/> is the pre-collision weight of the particle as it enters event
<img class="math" src="../_images/math/34857b3ba74ce5cd8607f3ebd23e9015908ada71.png" alt="i"/>. One should note that equation <a href="#equation-analog-estimator">(2)</a> is
volume-integrated so if we want a volume-averaged quantity, we need to divided
by the volume of the region of integration.</p>
</div>
<div class="section" id="collision-estimator">
<h3>6.3.2. Collision Estimator<a class="headerlink" href="#collision-estimator" title="Permalink to this headline">¶</a></h3>
<p>While the analog estimator is conceptually very simple and easy to implement, it
can suffer higher variance due to the fact low probability events will not occur
often enough to get good statistics if they are being tallied. Thus, it is
desirable to use a different estimator that allows us to score to the tally more
often. One such estimator is the collision estimator. Instead of tallying a
reaction only when it happens, the idea is to make a contribution to the tally
at every collision.</p>
<p>We can start by writing a formula for the collision estimate of the flux. Since
<img class="math" src="../_images/math/ef40236472d14c5013d9f4337d6278d01028e4c5.png" alt="R = \Sigma_t \phi"/> where <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> is the total reaction rate,
<img class="math" src="../_images/math/b5e850feb16eb83bd01af5524126befff31f202b.png" alt="\Sigma_t"/> is the total macroscopic cross section, and <img class="math" src="../_images/math/2c175f60eecef1de7560c3bdea495d69f26f719d.png" alt="\phi"/> is the
scalar flux, it stands to reason that we can estimate the flux by taking an
estimate of the total reaction rate and dividing it by the total macroscopic
cross section. This gives us the following formula:</p>
<div class="math" id="equation-collision-estimator-flux">
<p><span class="eqno">(3)</span><img src="../_images/math/99bb09b89d1018e8112899db4e6db62187f2b882.png" alt="\phi = \frac{1}{W} \sum_{i \in C} \frac{w_i}{\Sigma_t (E_i)}"/></p>
</div><p>where <img class="math" src="../_images/math/10cb764f88509fb1c8012366993fdbee98f31bc5.png" alt="W"/> is again the total starting weight of the particles, <img class="math" src="../_images/math/c3355896da590fc491a10150a50416687626d7cc.png" alt="C"/>
is the set of all events resulting in a collision with a nucleus, and
<img class="math" src="../_images/math/4123c4fb5bd5659657f63f0d4e59e06c6eaab8f7.png" alt="\Sigma_t (E)"/> is the total macroscopic cross section of the target
material at the incoming energy of the particle <img class="math" src="../_images/math/f8f358aa01478e43f1a663db574b83f88d7be478.png" alt="E_i"/>.</p>
<p>If we multiply both sides of equation <a href="#equation-collision-estimator-flux">(3)</a> by the
macroscopic cross section for some reaction <img class="math" src="../_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/>, then we get the collision
estimate for the reaction rate for that reaction:</p>
<div class="math" id="equation-collision-estimator">
<p><span class="eqno">(4)</span><img src="../_images/math/d8eef5a56ca8e57f1809928db6159a4d5bfee23e.png" alt="R_x = \frac{1}{W} \sum_{i \in C} \frac{w_i \Sigma_x (E_i)}{\Sigma_t (E_i)}"/></p>
</div><p>where <img class="math" src="../_images/math/c9dff1417dfadc1338c77d9000f382dc03e058b5.png" alt="\Sigma_x (E_i)"/> is the macroscopic cross section for reaction
<img class="math" src="../_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/> at the incoming energy of the particle <img class="math" src="../_images/math/f8f358aa01478e43f1a663db574b83f88d7be478.png" alt="E_i"/>. In comparison to
equation <a href="#equation-analog-estimator">(2)</a>, we see that the collision estimate will result
in a tally with a larger number of events that score to it with smaller
contributions (since we have multiplied it by <img class="math" src="../_images/math/2c2a5691af9fdc06c3b76d195adc8cfac1aa2f29.png" alt="\Sigma_x / \Sigma_t"/>).</p>
</div>
<div class="section" id="track-length-estimator">
<h3>6.3.3. Track-length Estimator<a class="headerlink" href="#track-length-estimator" title="Permalink to this headline">¶</a></h3>
<p>One other method we can use to increase the number of events that scores to
tallies is to use an estimator the scores contributions to a tally at every
track for the particle rather than every collision. This is known as a
track-length estimator, sometimes also called a path-length estimator. We first
start with an expression for the volume integrated flux, which can be written as</p>
<div class="math" id="equation-flux-integrated">
<p><span class="eqno">(5)</span><img src="../_images/math/d6b5b60943e09b96c6f8ff0bccfdcdba8a92324e.png" alt="V \phi = \int d\mathbf{r} \int dE \int d\mathbf{\Omega} \int dt \,
\psi(\mathbf{r}, \mathbf{\hat{\Omega}}, E, t)."/></p>
</div><p>where <img class="math" src="../_images/math/12d58aa29201da09d8e620f8698e3a37547f6b4a.png" alt="V"/> is the volume, <img class="math" src="../_images/math/8ada738001410f131563551fb68731e4f302048d.png" alt="\psi"/> is the angular flux,
<img class="math" src="../_images/math/523765e6f77d2ff678e47c2a1ff0a59ace2e8e36.png" alt="\mathbf{r}"/> is the position of the particle, <img class="math" src="../_images/math/24e80eca0896a9a27e062e99d624799f9d56e32e.png" alt="\mathbf{\hat{\Omega}}"/>
is the direction of the particle, <img class="math" src="../_images/math/fa2fa899f0afb05d6837885523503a2d4df434f9.png" alt="E"/> is the energy of the particle, and
<img class="math" src="../_images/math/e0d2bf360290fd61d1c1557e763f2622363b3d35.png" alt="t"/> is the time. By noting that <img class="math" src="../_images/math/6b2b5dfc3fdb49110e9ead9119859587d8ab9400.png" alt="\psi(\mathbf{r},
\mathbf{\hat{\Omega}}, E, t) = v n(\mathbf{r}, \mathbf{\hat{\Omega}}, E, t)"/>
where <img class="math" src="../_images/math/174fadd07fd54c9afe288e96558c92e0c1da733a.png" alt="n"/> is the angular neutron density, we can rewrite equation
<a href="#equation-flux-integrated">(5)</a> as</p>
<div class="math" id="equation-flux-integrated-2">
<p><span class="eqno">(6)</span><img src="../_images/math/7b1ba583dd94da2078b240e3f6b2e6c6a870d63f.png" alt="V \phi = \int d\mathbf{r} \int dE \int dt v \int d\mathbf{\Omega} \, n(\mathbf{r},
\mathbf{\hat{\Omega}}, E, t))"/></p>
</div><p>Using the relations <img class="math" src="../_images/math/fbd773ff4c9cf09101895f518aed3096cf05ac27.png" alt="N(\mathbf{r}, E, t) = \int d\mathbf{\Omega}
n(\mathbf{r}, \mathbf{\hat{\Omega}}, E, t)"/> and <img class="math" src="../_images/math/1398cc90f5d6dc57f5585101970e32be7345d130.png" alt="d\ell = v \, dt"/> where
<img class="math" src="../_images/math/492e4dcffdca8aa5f0f342ec9309bc75ca90b7f1.png" alt="d\ell"/> is the differential unit of track length, we then obtain</p>
<div class="math" id="equation-track-length-integral">
<p><span class="eqno">(7)</span><img src="../_images/math/5e88ecae09ba1f2688572248e61c024774b756a1.png" alt="V \phi = \int d\mathbf{r} \int dE \int d\ell N(\mathbf{r}, E, t)"/></p>
</div><p>Equation <a href="#equation-track-length-integral">(7)</a> indicates that we can use the length of a
particle&#8217;s trajectory as an estimate for the flux, i.e. the track-length
estimator of the flux would be</p>
<div class="math" id="equation-track-length-flux">
<p><span class="eqno">(8)</span><img src="../_images/math/821c18828f9814f8f0d361cd228fafe06543c582.png" alt="\phi = \frac{1}{W} \sum_{i \in T} w_i \ell_i"/></p>
</div><p>where <img class="math" src="../_images/math/2554b6496c3b678897e9b060ef00aa9f0a7d7ece.png" alt="T"/> is the set of all the particle&#8217;s trajectories within the desired
volume and <img class="math" src="../_images/math/cb2fdb61ac5f2b89ddc5b4207d7f3f1cb6a2c504.png" alt="\ell_i"/> is the length of the <img class="math" src="../_images/math/34857b3ba74ce5cd8607f3ebd23e9015908ada71.png" alt="i"/>-th trajectory. In the
same vein as equation <a href="#equation-collision-estimator">(4)</a>, the track-length estimate of a
reaction rate is found by multiplying equation <a href="#equation-track-length-flux">(8)</a> by a
macroscopic reaction cross section:</p>
<div class="math" id="equation-track-length-estimator">
<p><span class="eqno">(9)</span><img src="../_images/math/f8c5da59a13a4d083fba1bf493a394ed62839e37.png" alt="R_x = \frac{1}{W} \sum_{i \in T} w_i \ell_i \Sigma_x (E_i)"/></p>
</div><p>One important fact to take into consideration is that the use of a track-length
estimator precludes us from using any filter that requires knowledge of the
particle&#8217;s state following a collision because by definition, it will not have
had a collision at every event. Thus, for tallies with outgoing-energy filters
(which require the post-collision energy) or for tallies of scattering moments
(which require the scattering cosine), we must use an analog estimator.</p>
</div>
</div>
<div class="section" id="surface-current">
<h2>6.4. Surface Current<a class="headerlink" href="#surface-current" title="Permalink to this headline">¶</a></h2>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="physics.html">5. Physics</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="parallelization.html">7. Parallelization</a>&#160;&#160;»
        </p>

      </div>


    <div class="footer">
        &copy; Copyright 2011-2012, Massachusetts Institute of Technology.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30411614-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>