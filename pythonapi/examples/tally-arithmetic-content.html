<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Generate Input Files &mdash; OpenMC Documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMC Documentation" href="../../index.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner">
        <a href="../../index.html">
          <img class="logo" src="../../_static/openmc.png" alt="Logo"/>
        </a>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <p>This notebook shows the how tallies can be combined (added, subtracted,
multiplied, etc.) using the Python API in order to create derived
tallies. Since no covariance information is obtained, it is assumed that
tallies are completely independent of one another when propagating
uncertainties. The target problem is a simple pin cell.</p>
<p><strong>Note:</strong> that this Notebook was created using the latest Pandas
v0.16.1. Everything in the Notebook will wun with older versions of
Pandas, but the multi-indexing option in &gt;v0.15.0 makes the tables look
prettier.</p>
<div class="code python highlight-python"><div class="highlight"><pre>%load_ext autoreload
%autoreload 2
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre>import glob
from IPython.display import Image
import numpy as np

import openmc
from openmc.statepoint import StatePoint
from openmc.summary import Summary

%matplotlib inline
</pre></div>
</div>
<div class="section" id="generate-input-files">
<h1>Generate Input Files<a class="headerlink" href="#generate-input-files" title="Permalink to this headline">Â¶</a></h1>
<p>First we need to define materials that will be used in the problem.
Before defining a material, we must create nuclides that are used in the
material.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate some Nuclides</span>
<span class="n">h1</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;H-1&#39;</span><span class="p">)</span>
<span class="n">b10</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;B-10&#39;</span><span class="p">)</span>
<span class="n">o16</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;O-16&#39;</span><span class="p">)</span>
<span class="n">u235</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;U-235&#39;</span><span class="p">)</span>
<span class="n">u238</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;U-238&#39;</span><span class="p">)</span>
<span class="n">zr90</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;Zr-90&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>With the nuclides we defined, we will now create three materials for the
fuel, water, and cladding of the fuel pin.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># 1.6 enriched fuel</span>
<span class="n">fuel</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6</span><span class="si">% F</span><span class="s">uel&#39;</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="s">&#39;g/cm3&#39;</span><span class="p">,</span> <span class="mf">10.31341</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">u235</span><span class="p">,</span> <span class="mf">3.7503e-4</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">u238</span><span class="p">,</span> <span class="mf">2.2625e-2</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">o16</span><span class="p">,</span> <span class="mf">4.6007e-2</span><span class="p">)</span>

<span class="c"># borated water</span>
<span class="n">water</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Borated Water&#39;</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="s">&#39;g/cm3&#39;</span><span class="p">,</span> <span class="mf">0.740582</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="mf">4.9457e-2</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">o16</span><span class="p">,</span> <span class="mf">2.4732e-2</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">b10</span><span class="p">,</span> <span class="mf">8.0042e-6</span><span class="p">)</span>

<span class="c"># zircaloy</span>
<span class="n">zircaloy</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Zircaloy&#39;</span><span class="p">)</span>
<span class="n">zircaloy</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="s">&#39;g/cm3&#39;</span><span class="p">,</span> <span class="mf">6.55</span><span class="p">)</span>
<span class="n">zircaloy</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">zr90</span><span class="p">,</span> <span class="mf">7.2758e-3</span><span class="p">)</span>
</pre></div>
</div>
<p>With our three materials, we can now create a materials file object that
can be exported to an actual XML file.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a MaterialsFile, add Materials</span>
<span class="n">materials_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">MaterialsFile</span><span class="p">()</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span><span class="n">fuel</span><span class="p">)</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span><span class="n">water</span><span class="p">)</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span><span class="n">zircaloy</span><span class="p">)</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">default_xs</span> <span class="o">=</span> <span class="s">&#39;71c&#39;</span>

<span class="c"># Export to &quot;materials.xml&quot;</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>Now let&#8217;s move on to the geometry. Our problem will have three regions
for the fuel, the clad, and the surrounding coolant. The first step is
to create the bounding surfaces &#8211; in this case two cylinders and six
reflective planes.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create cylinders for the fuel and clad</span>
<span class="n">fuel_outer_radius</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZCylinder</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">0.39218</span><span class="p">)</span>
<span class="n">clad_outer_radius</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZCylinder</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">0.45720</span><span class="p">)</span>

<span class="c"># Create boundary planes to surround the geometry</span>
<span class="c"># Use both reflective and vacuum boundaries to make life interesting</span>
<span class="n">min_x</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">XPlane</span><span class="p">(</span><span class="n">x0</span><span class="o">=-</span><span class="mf">0.63</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">max_x</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">XPlane</span><span class="p">(</span><span class="n">x0</span><span class="o">=+</span><span class="mf">0.63</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">min_y</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">YPlane</span><span class="p">(</span><span class="n">y0</span><span class="o">=-</span><span class="mf">0.63</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">max_y</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">YPlane</span><span class="p">(</span><span class="n">y0</span><span class="o">=+</span><span class="mf">0.63</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">min_z</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZPlane</span><span class="p">(</span><span class="n">z0</span><span class="o">=-</span><span class="mf">0.63</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">max_z</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZPlane</span><span class="p">(</span><span class="n">z0</span><span class="o">=+</span><span class="mf">0.63</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>With the surfaces defined, we can now create cells that are defined by
intersections of half-spaces created by the surfaces.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create a Universe to encapsulate a fuel pin</span>
<span class="n">pin_cell_universe</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6</span><span class="si">% F</span><span class="s">uel Pin&#39;</span><span class="p">)</span>

<span class="c"># Create fuel Cell</span>
<span class="n">fuel_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6</span><span class="si">% F</span><span class="s">uel&#39;</span><span class="p">)</span>
<span class="n">fuel_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">fuel</span>
<span class="n">fuel_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">-</span><span class="n">fuel_outer_radius</span>
<span class="n">pin_cell_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">fuel_cell</span><span class="p">)</span>

<span class="c"># Create a clad Cell</span>
<span class="n">clad_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6% Clad&#39;</span><span class="p">)</span>
<span class="n">clad_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">zircaloy</span>
<span class="n">clad_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">fuel_outer_radius</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">clad_outer_radius</span>
<span class="n">pin_cell_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">clad_cell</span><span class="p">)</span>

<span class="c"># Create a moderator Cell</span>
<span class="n">moderator_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6% Moderator&#39;</span><span class="p">)</span>
<span class="n">moderator_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">water</span>
<span class="n">moderator_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">clad_outer_radius</span>
<span class="n">pin_cell_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">moderator_cell</span><span class="p">)</span>
</pre></div>
</div>
<p>OpenMC requires that there is a &#8220;root&#8221; universe. Let us create a root
cell that is filled by the pin cell universe and then assign it to the
root universe.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create root Cell</span>
<span class="n">root_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;root cell&#39;</span><span class="p">)</span>
<span class="n">root_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">pin_cell_universe</span>

<span class="c"># Add boundary planes</span>
<span class="n">root_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">min_x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">max_x</span> <span class="o">&amp;</span> <span class="o">+</span><span class="n">min_y</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">max_y</span> <span class="o">&amp;</span> <span class="o">+</span><span class="n">min_z</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">max_z</span>

<span class="c"># Create root Universe</span>
<span class="n">root_universe</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">universe_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;root universe&#39;</span><span class="p">)</span>
<span class="n">root_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">root_cell</span><span class="p">)</span>
</pre></div>
</div>
<p>We now must create a geometry that is assigned a root universe, put the
geometry into a geometry file, and export it to XML.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create Geometry and set root Universe</span>
<span class="n">geometry</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Geometry</span><span class="p">()</span>
<span class="n">geometry</span><span class="o">.</span><span class="n">root_universe</span> <span class="o">=</span> <span class="n">root_universe</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a GeometryFile</span>
<span class="n">geometry_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">GeometryFile</span><span class="p">()</span>
<span class="n">geometry_file</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>

<span class="c"># Export to &quot;geometry.xml&quot;</span>
<span class="n">geometry_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>With the geometry and materials finished, we now just need to define
simulation parameters. In this case, we will use 5 inactive batches and
15 active batches each with 2500 particles.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># OpenMC simulation parameters</span>
<span class="n">batches</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">inactive</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">particles</span> <span class="o">=</span> <span class="mi">2500</span>

<span class="c"># Instantiate a SettingsFile</span>
<span class="n">settings_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">SettingsFile</span><span class="p">()</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">inactive</span> <span class="o">=</span> <span class="n">inactive</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tallies&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;summary&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
<span class="n">source_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.63</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.63</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">]</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">set_source_space</span><span class="p">(</span><span class="s">&#39;box&#39;</span><span class="p">,</span> <span class="n">source_bounds</span><span class="p">)</span>

<span class="c"># Export to &quot;settings.xml&quot;</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>Let us also create a plot file that we can use to verify that our pin
cell geometry was created successfully.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a Plot</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plot_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;materials-xy&#39;</span>
<span class="n">plot</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">plot</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.26</span><span class="p">,</span> <span class="mf">1.26</span><span class="p">]</span>
<span class="n">plot</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">]</span>
<span class="n">plot</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="s">&#39;mat&#39;</span>

<span class="c"># Instantiate a PlotsFile, add Plot, and export to &quot;plots.xml&quot;</span>
<span class="n">plot_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">PlotsFile</span><span class="p">()</span>
<span class="n">plot_file</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
<span class="n">plot_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>With the plots.xml file, we can now generate and view the plot. OpenMC
outputs plots in .ppm format, which can be converted into a compressed
format like .png with the convert utility.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Run openmc in plotting mode</span>
<span class="n">executor</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Executor</span><span class="p">()</span>
<span class="n">executor</span><span class="o">.</span><span class="n">plot_geometry</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">0</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre># Convert OpenMC&#39;s funky ppm to png
!convert materials-xy.ppm materials-xy.png

# Display the materials plot inline
Image(filename=&#39;materials-xy.png&#39;)
</pre></div>
</div>
<img alt="../../_images/tally-arithmetic-content_25_0.png" src="../../_images/tally-arithmetic-content_25_0.png" />
<p>As we can see from the plot, we have a nice pin cell with fuel,
cladding, and water! Before we run our simulation, we need to tell the
code what we want to tally. The following code shows how to create a
variety of tallies.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate an empty TalliesFile</span>
<span class="n">tallies_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">TalliesFile</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create Tallies to compute microscopic multi-group cross-sections</span>

<span class="c"># Instantiate energy filter for multi-group cross-section Tallies</span>
<span class="n">energy_filter</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.625e-6</span><span class="p">,</span> <span class="mf">20.</span><span class="p">])</span>

<span class="c"># Instantiate flux Tally in moderator and fuel</span>
<span class="n">tally</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;cell&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">fuel_cell</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">moderator_cell</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">energy_filter</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">tally</span><span class="p">)</span>

<span class="c"># Instantiate reaction rate Tally in fuel</span>
<span class="n">tally</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fuel rxn rates&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;cell&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">fuel_cell</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">energy_filter</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;nu-fission&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;scatter&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">u238</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">u235</span><span class="p">)</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">tally</span><span class="p">)</span>

<span class="c"># Instantiate reaction rate Tally in moderator</span>
<span class="n">tally</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;moderator rxn rates&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;cell&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">moderator_cell</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">energy_filter</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;absorption&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;total&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">o16</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">tally</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># K-Eigenvalue (infinity) tallies</span>
<span class="n">fiss_rate</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fiss. rate&#39;</span><span class="p">)</span>
<span class="n">abs_rate</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;abs. rate&#39;</span><span class="p">)</span>
<span class="n">fiss_rate</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;nu-fission&#39;</span><span class="p">)</span>
<span class="n">abs_rate</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;absorption&#39;</span><span class="p">)</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">fiss_rate</span><span class="p">)</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">abs_rate</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Resonance Escape Probability tallies</span>
<span class="n">therm_abs_rate</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;therm. abs. rate&#39;</span><span class="p">)</span>
<span class="n">therm_abs_rate</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;absorption&#39;</span><span class="p">)</span>
<span class="n">therm_abs_rate</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">]))</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">therm_abs_rate</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Thermal Flux Utilization tallies</span>
<span class="n">fuel_therm_abs_rate</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fuel therm. abs. rate&#39;</span><span class="p">)</span>
<span class="n">fuel_therm_abs_rate</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;absorption&#39;</span><span class="p">)</span>
<span class="n">fuel_therm_abs_rate</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">]))</span>
<span class="n">fuel_therm_abs_rate</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;cell&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">fuel_cell</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">fuel_therm_abs_rate</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Fast Fission Factor tallies</span>
<span class="n">therm_fiss_rate</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;therm. fiss. rate&#39;</span><span class="p">)</span>
<span class="n">therm_fiss_rate</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;nu-fission&#39;</span><span class="p">)</span>
<span class="n">therm_fiss_rate</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">]))</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">therm_fiss_rate</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate energy filter to illustrate Tally slicing</span>
<span class="n">energy_filter</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>

<span class="c"># Instantiate flux Tally in moderator and fuel</span>
<span class="n">tally</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;need-to-slice&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;cell&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">fuel_cell</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">moderator_cell</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">energy_filter</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;nu-fission&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;scatter&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">u238</span><span class="p">)</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">tally</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Export to &quot;tallies.xml&quot;</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>Now we a have a complete set of inputs, so we can go ahead and run our
simulation.</p>
<div class="code python highlight-python"><div class="highlight"><pre># Remove old HDF5 (summary, statepoint) files
!rm statepoint.*

# Run OpenMC with MPI!
executor.run_simulation()
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>       .d88888b.                             888b     d888  .d8888b.
      d88P&quot; &quot;Y88b                            8888b   d8888 d88P  Y88b
      888     888                            88888b.d88888 888    888
      888     888 88888b.   .d88b.  88888b.  888Y88888P888 888
      888     888 888 &quot;88b d8P  Y8b 888 &quot;88b 888 Y888P 888 888
      888     888 888  888 88888888 888  888 888  Y8P  888 888    888
      Y88b. .d88P 888 d88P Y8b.     888  888 888   &quot;   888 Y88b  d88P
       &quot;Y88888P&quot;  88888P&quot;   &quot;Y8888  888  888 888       888  &quot;Y8888P&quot;
__________________888______________________________________________________
                  888
                  888

      Copyright:      2011-2015 Massachusetts Institute of Technology
      License:        http://mit-crpg.github.io/openmc/license.html
      Version:        0.7.0
      Git SHA1:       74ffcb447521c968fb64fdaa63e40598783f2fba
      Date/Time:      2015-11-25 14:20:51
      MPI Processes:  1

 ===========================================================================
 ========================&gt;     INITIALIZATION     &lt;=========================
 ===========================================================================

 Reading settings XML file...
 Reading cross sections XML file...
 Reading geometry XML file...
 Reading materials XML file...
 Reading tallies XML file...
 Building neighboring cells lists for each surface...
 Loading ACE cross section table: 92235.71c
 Loading ACE cross section table: 92238.71c
 Loading ACE cross section table: 8016.71c
 Loading ACE cross section table: 1001.71c
 Loading ACE cross section table: 5010.71c
 Loading ACE cross section table: 40090.71c
 Maximum neutron transport energy: 20.0000 MeV for 92235.71c
 Initializing source particles...

 ===========================================================================
 ====================&gt;     K EIGENVALUE SIMULATION     &lt;====================
 ===========================================================================

  Bat./Gen.      k            Average k
  =========   ========   ====================
        1/1    1.05992
        2/1    1.05251
        3/1    1.05204
        4/1    1.02100
        5/1    1.07784
        6/1    1.04814
        7/1    1.02335    1.03574 +/- 0.01239
        8/1    1.02415    1.03188 +/- 0.00813
        9/1    1.10331    1.04974 +/- 0.01876
       10/1    1.05452    1.05069 +/- 0.01456
       11/1    1.07867    1.05536 +/- 0.01277
       12/1    1.04203    1.05345 +/- 0.01096
       13/1    1.04482    1.05237 +/- 0.00955
       14/1    1.04116    1.05113 +/- 0.00852
       15/1    1.07569    1.05358 +/- 0.00800
       16/1    1.04188    1.05252 +/- 0.00732
       17/1    1.03775    1.05129 +/- 0.00679
       18/1    0.98462    1.04616 +/- 0.00808
       19/1    1.08613    1.04902 +/- 0.00801
       20/1    1.00571    1.04613 +/- 0.00800
 Creating state point statepoint.20.h5...

 ===========================================================================
 ======================&gt;     SIMULATION FINISHED     &lt;======================
 ===========================================================================


 =======================&gt;     TIMING STATISTICS     &lt;=======================

 Total time for initialization     =  7.9600E-01 seconds
   Reading cross sections          =  2.1200E-01 seconds
 Total time in simulation          =  1.8740E+01 seconds
   Time in transport only          =  1.8727E+01 seconds
   Time in inactive batches        =  2.5970E+00 seconds
   Time in active batches          =  1.6143E+01 seconds
   Time synchronizing fission bank =  2.0000E-03 seconds
     Sampling source sites         =  1.0000E-03 seconds
     SEND/RECV source sites        =  1.0000E-03 seconds
   Time accumulating tallies       =  0.0000E+00 seconds
 Total time for finalization       =  2.0000E-03 seconds
 Total time elapsed                =  1.9553E+01 seconds
 Calculation Rate (inactive)       =  4813.25 neutrons/second
 Calculation Rate (active)         =  2322.99 neutrons/second

 ============================&gt;     RESULTS     &lt;============================

 k-effective (Collision)     =  1.04597 +/-  0.00663
 k-effective (Track-length)  =  1.04613 +/-  0.00800
 k-effective (Absorption)    =  1.04087 +/-  0.00627
 Combined k-effective        =  1.04322 +/-  0.00570
 Leakage Fraction            =  0.00000 +/-  0.00000
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="tally-data-processing">
<h1>Tally Data Processing<a class="headerlink" href="#tally-data-processing" title="Permalink to this headline">Â¶</a></h1>
<p>Our simulation ran successfully and created a statepoint file with all
the tally data in it. We begin our analysis here loading the statepoint
file and &#8216;reading&#8217; the results. By default, the tally results are not
read into memory because they might be large, even large enough to
exceed the available memory on a computer.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Load the statepoint file</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">StatePoint</span><span class="p">(</span><span class="s">&#39;statepoint.20.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You may have also noticed we instructed OpenMC to create a summary file
with lots of geometry information in it. This can help to produce more
sensible output from the Python API, so we will use the summary file to
link against.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Load the summary file and link with statepoint</span>
<span class="n">su</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">(</span><span class="s">&#39;summary.h5&#39;</span><span class="p">)</span>
<span class="n">sp</span><span class="o">.</span><span class="n">link_with_summary</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
</pre></div>
</div>
<p>We have a tally of the total fission rate and the total absorption rate,
so we can calculate k-infinity as:</p>
<div class="math">
\[k_\infty = \frac{\langle \nu \Sigma_f \phi \rangle}{\langle \Sigma_a \phi \rangle}\]</div>
<p>In this notation, <span class="math">\(\langle \cdot \rangle^a_b\)</span> represents an OpenMC
that is integrated over region <span class="math">\(a\)</span> and energy range <span class="math">\(b\)</span>. If
<span class="math">\(a\)</span> or <span class="math">\(b\)</span> is not reported, it means the value represents an
integral over all space or all energy, respectively.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Compute k-infinity using tally arithmetic</span>
<span class="n">fiss_rate</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fiss. rate&#39;</span><span class="p">)</span>
<span class="n">abs_rate</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;abs. rate&#39;</span><span class="p">)</span>
<span class="n">keff</span> <span class="o">=</span> <span class="n">fiss_rate</span> <span class="o">/</span> <span class="n">abs_rate</span>
<span class="n">keff</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> total</td>
      <td> (nu-fission / absorption)</td>
      <td> 1.040687</td>
      <td> 0.010913</td>
    </tr>
  </tbody>
</table>
</div><p>Notice that even though the neutron production rate and absorption rate
are separate tallies, we still get a first-order estimate of the
uncertainty on the quotient of them automatically!</p>
<p>Often in textbooks you&#8217;ll see k-infinity represented using the
four-factor formula</p>
<div class="math">
\[k_\infty = p \epsilon f \eta.\]</div>
<p>Let&#8217;s analyze each of these factors, starting with the resonance escape
probability which is defined as</p>
<div class="math">
\[p=\frac{\langle\Sigma_a\phi\rangle_T}{\langle\Sigma_a\phi\rangle}\]\[where the subscript :math:`T` means thermal energies.\]</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Compute resonance escape probability using tally arithmetic</span>
<span class="n">therm_abs_rate</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;therm. abs. rate&#39;</span><span class="p">)</span>
<span class="n">res_esc</span> <span class="o">=</span> <span class="n">therm_abs_rate</span> <span class="o">/</span> <span class="n">abs_rate</span>
<span class="n">res_esc</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>energy [MeV]</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> (0.0e+00 - 6.2e-01)</td>
      <td> total</td>
      <td> absorption</td>
      <td> 0.959302</td>
      <td> 0.010033</td>
    </tr>
  </tbody>
</table>
</div><p>The fast fission factor can be calculated as</p>
<div class="math">
\[\epsilon=\frac{\langle\nu\Sigma_f\phi\rangle}{\langle\nu\Sigma_f\phi\rangle_T}\]</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Compute fast fission factor factor using tally arithmetic</span>
<span class="n">therm_fiss_rate</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;therm. fiss. rate&#39;</span><span class="p">)</span>
<span class="n">fast_fiss</span> <span class="o">=</span> <span class="n">fiss_rate</span> <span class="o">/</span> <span class="n">therm_fiss_rate</span>
<span class="n">fast_fiss</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>energy [MeV]</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> (0.0e+00 - 6.2e-01)</td>
      <td> total</td>
      <td> nu-fission</td>
      <td> 1.09103</td>
      <td> 0.012491</td>
    </tr>
  </tbody>
</table>
</div><p>The thermal flux utilization is calculated as</p>
<div class="math">
\[f=\frac{\langle\Sigma_a\phi\rangle^F_T}{\langle\Sigma_a\phi\rangle_T}\]</div>
<p>where the superscript <span class="math">\(F\)</span> denotes fuel.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Compute thermal flux utilization factor using tally arithmetic</span>
<span class="n">fuel_therm_abs_rate</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fuel therm. abs. rate&#39;</span><span class="p">)</span>
<span class="n">therm_util</span> <span class="o">=</span> <span class="n">fuel_therm_abs_rate</span> <span class="o">/</span> <span class="n">therm_abs_rate</span>
<span class="n">therm_util</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>energy [MeV]</th>
      <th>cell</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> (0.0e+00 - 6.2e-01)</td>
      <td> 10000</td>
      <td> total</td>
      <td> absorption</td>
      <td> 0.803182</td>
      <td> 0.008664</td>
    </tr>
  </tbody>
</table>
</div><p>The final factor is the number of fission neutrons produced per
absorption in fuel, calculated as</p>
<div class="math">
\[\eta = \frac{\langle \nu\Sigma_f\phi \rangle_T}{\langle \Sigma_a \phi \rangle^F_T}\]</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Compute neutrons produced per absorption (eta) using tally arithmetic</span>
<span class="n">eta</span> <span class="o">=</span> <span class="n">therm_fiss_rate</span> <span class="o">/</span> <span class="n">fuel_therm_abs_rate</span>
<span class="n">eta</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>energy [MeV]</th>
      <th>cell</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> (0.0e+00 - 6.2e-01)</td>
      <td> 10000</td>
      <td> total</td>
      <td> (nu-fission / absorption)</td>
      <td> 1.237982</td>
      <td> 0.014179</td>
    </tr>
  </tbody>
</table>
</div><p>Now we can calculate <span class="math">\(k_\infty\)</span> using the product of the factors
form the four-factor formula.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">keff</span> <span class="o">=</span> <span class="n">res_esc</span> <span class="o">*</span> <span class="n">fast_fiss</span> <span class="o">*</span> <span class="n">therm_util</span> <span class="o">*</span> <span class="n">eta</span>
<span class="n">keff</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>energy [MeV]</th>
      <th>cell</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> (0.0e+00 - 6.2e-01)</td>
      <td> 10000</td>
      <td> total</td>
      <td> (((absorption * nu-fission) * absorption) * (n...</td>
      <td> 1.040687</td>
      <td> 0.022989</td>
    </tr>
  </tbody>
</table>
</div><p>We see that the value we&#8217;ve obtained here has exactly the same mean as
before. However, because of the way it was calculated, the standard
deviation appears to be larger.</p>
<p>Let&#8217;s move on to a more complicated example now. Before we set up
tallies to get reaction rates in the fuel and moderator in two energy
groups for two different nuclides. We can use tally arithmetic to divide
each of these reaction rates by the flux to get microscopic multi-group
cross sections.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Compute microscopic multi-group cross-sections</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;cell&#39;</span><span class="p">],</span> <span class="n">filter_bins</span><span class="o">=</span><span class="p">[(</span><span class="n">fuel_cell</span><span class="o">.</span><span class="n">id</span><span class="p">,)])</span>
<span class="n">fuel_rxn_rates</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fuel rxn rates&#39;</span><span class="p">)</span>
<span class="n">mod_rxn_rates</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;moderator rxn rates&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">fuel_xs</span> <span class="o">=</span> <span class="n">fuel_rxn_rates</span> <span class="o">/</span> <span class="n">flux</span>
<span class="n">fuel_xs</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cell</th>
      <th>energy [MeV]</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> 10000</td>
      <td> (0.0e+00 - 6.3e-07)</td>
      <td> (U-238 / total)</td>
      <td> (nu-fission / flux)</td>
      <td> 0.000001</td>
      <td> 8.078651e-09</td>
    </tr>
    <tr>
      <th>1</th>
      <td> 10000</td>
      <td> (0.0e+00 - 6.3e-07)</td>
      <td> (U-238 / total)</td>
      <td>    (scatter / flux)</td>
      <td> 0.209990</td>
      <td> 2.449396e-03</td>
    </tr>
    <tr>
      <th>2</th>
      <td> 10000</td>
      <td> (0.0e+00 - 6.3e-07)</td>
      <td> (U-235 / total)</td>
      <td> (nu-fission / flux)</td>
      <td> 0.356117</td>
      <td> 4.364366e-03</td>
    </tr>
    <tr>
      <th>3</th>
      <td> 10000</td>
      <td> (0.0e+00 - 6.3e-07)</td>
      <td> (U-235 / total)</td>
      <td>    (scatter / flux)</td>
      <td> 0.005555</td>
      <td> 6.495710e-05</td>
    </tr>
    <tr>
      <th>4</th>
      <td> 10000</td>
      <td> (6.3e-07 - 2.0e+01)</td>
      <td> (U-238 / total)</td>
      <td> (nu-fission / flux)</td>
      <td> 0.007190</td>
      <td> 7.596666e-05</td>
    </tr>
    <tr>
      <th>5</th>
      <td> 10000</td>
      <td> (6.3e-07 - 2.0e+01)</td>
      <td> (U-238 / total)</td>
      <td>    (scatter / flux)</td>
      <td> 0.227843</td>
      <td> 1.024510e-03</td>
    </tr>
    <tr>
      <th>6</th>
      <td> 10000</td>
      <td> (6.3e-07 - 2.0e+01)</td>
      <td> (U-235 / total)</td>
      <td> (nu-fission / flux)</td>
      <td> 0.008086</td>
      <td> 6.251590e-05</td>
    </tr>
    <tr>
      <th>7</th>
      <td> 10000</td>
      <td> (6.3e-07 - 2.0e+01)</td>
      <td> (U-235 / total)</td>
      <td>    (scatter / flux)</td>
      <td> 0.003365</td>
      <td> 1.646663e-05</td>
    </tr>
  </tbody>
</table>
</div><p>We see that when the two tallies with multiple bins were divided, the
derived tally contains the outer product of the combinations. If the
filters/scores are the same, no outer product is needed. The
<code class="docutils literal"><span class="pre">get_values(...)</span></code> method allows us to obtain a subset of tally scores.
In the following example, we obtain just the neutron production
microscopic cross sections.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Show how to use Tally.get_values(...) with a CrossScore</span>
<span class="n">nu_fiss_xs</span> <span class="o">=</span> <span class="n">fuel_xs</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;(nu-fission / flux)&#39;</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">nu_fiss_xs</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[[[</span>  <span class="mf">6.65302296e-07</span><span class="p">]</span>
  <span class="p">[</span>  <span class="mf">3.56116716e-01</span><span class="p">]]</span>

 <span class="p">[[</span>  <span class="mf">7.19004460e-03</span><span class="p">]</span>
  <span class="p">[</span>  <span class="mf">8.08598751e-03</span><span class="p">]]]</span>
</pre></div>
</div>
<p>The same idea can be used not only for scores but also for filters and
nuclides.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Show how to use Tally.get_values(...) with a CrossScore and CrossNuclide</span>
<span class="n">u235_scatter_xs</span> <span class="o">=</span> <span class="n">fuel_xs</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">nuclides</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;(U-235 / total)&#39;</span><span class="p">],</span>
                                <span class="n">scores</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;(scatter / flux)&#39;</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">u235_scatter_xs</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[[[</span> <span class="mf">0.00555516</span><span class="p">]]</span>

 <span class="p">[[</span> <span class="mf">0.00336498</span><span class="p">]]]</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Show how to use Tally.get_values(...) with a CrossFilter and CrossScore</span>
<span class="n">fast_scatter_xs</span> <span class="o">=</span> <span class="n">fuel_xs</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">],</span>
                                     <span class="n">filter_bins</span><span class="o">=</span><span class="p">[((</span><span class="mf">0.625e-6</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),)],</span>
                                     <span class="n">scores</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;(scatter / flux)&#39;</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">fast_scatter_xs</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[[[</span> <span class="mf">0.22784316</span><span class="p">]</span>
  <span class="p">[</span> <span class="mf">0.00336498</span><span class="p">]]]</span>
</pre></div>
</div>
<p>A more advanced method is to use <code class="docutils literal"><span class="pre">get_slice(...)</span></code> to create a new
derived tally that is a subset of an existing tally. This has the
benefit that we can use <code class="docutils literal"><span class="pre">get_pandas_dataframe()</span></code> to see the tallies in
a more human-readable format.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># &quot;Slice&quot; the nu-fission data into a new derived Tally</span>
<span class="n">nu_fission_rates</span> <span class="o">=</span> <span class="n">fuel_rxn_rates</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;nu-fission&#39;</span><span class="p">])</span>
<span class="n">nu_fission_rates</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cell</th>
      <th>energy [MeV]</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> 10000</td>
      <td> (0.0e+00 - 6.3e-07)</td>
      <td> U-238</td>
      <td> nu-fission</td>
      <td> 0.000002</td>
      <td> 1.450189e-08</td>
    </tr>
    <tr>
      <th>1</th>
      <td> 10000</td>
      <td> (0.0e+00 - 6.3e-07)</td>
      <td> U-235</td>
      <td> nu-fission</td>
      <td> 0.870882</td>
      <td> 7.895515e-03</td>
    </tr>
    <tr>
      <th>2</th>
      <td> 10000</td>
      <td> (6.3e-07 - 2.0e+01)</td>
      <td> U-238</td>
      <td> nu-fission</td>
      <td> 0.082484</td>
      <td> 8.253437e-04</td>
    </tr>
    <tr>
      <th>3</th>
      <td> 10000</td>
      <td> (6.3e-07 - 2.0e+01)</td>
      <td> U-235</td>
      <td> nu-fission</td>
      <td> 0.092762</td>
      <td> 6.444580e-04</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-python"><div class="highlight"><pre><span class="c"># &quot;Slice&quot; the H-1 scatter data in the moderator Cell into a new derived Tally</span>
<span class="n">need_to_slice</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;need-to-slice&#39;</span><span class="p">)</span>
<span class="n">slice_test</span> <span class="o">=</span> <span class="n">need_to_slice</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;scatter&#39;</span><span class="p">],</span> <span class="n">nuclides</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;H-1&#39;</span><span class="p">],</span>
                                 <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;cell&#39;</span><span class="p">],</span> <span class="n">filter_bins</span><span class="o">=</span><span class="p">[(</span><span class="n">moderator_cell</span><span class="o">.</span><span class="n">id</span><span class="p">,)])</span>
<span class="n">slice_test</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cell</th>
      <th>energy [MeV]</th>
      <th>nuclide</th>
      <th>score</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> 10002</td>
      <td> (1.0e-08 - 1.1e-07)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 4.630154</td>
      <td> 0.044512</td>
    </tr>
    <tr>
      <th>1</th>
      <td> 10002</td>
      <td> (1.1e-07 - 1.2e-06)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 2.042984</td>
      <td> 0.011429</td>
    </tr>
    <tr>
      <th>2</th>
      <td> 10002</td>
      <td> (1.2e-06 - 1.3e-05)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 1.657517</td>
      <td> 0.008617</td>
    </tr>
    <tr>
      <th>3</th>
      <td> 10002</td>
      <td> (1.3e-05 - 1.4e-04)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 1.863326</td>
      <td> 0.008848</td>
    </tr>
    <tr>
      <th>4</th>
      <td> 10002</td>
      <td> (1.4e-04 - 1.5e-03)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 2.043916</td>
      <td> 0.014195</td>
    </tr>
    <tr>
      <th>5</th>
      <td> 10002</td>
      <td> (1.5e-03 - 1.6e-02)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 2.134458</td>
      <td> 0.007561</td>
    </tr>
    <tr>
      <th>6</th>
      <td> 10002</td>
      <td> (1.6e-02 - 1.7e-01)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 2.209947</td>
      <td> 0.013848</td>
    </tr>
    <tr>
      <th>7</th>
      <td> 10002</td>
      <td> (1.7e-01 - 1.9e+00)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 2.006967</td>
      <td> 0.009368</td>
    </tr>
    <tr>
      <th>8</th>
      <td> 10002</td>
      <td> (1.9e+00 - 2.0e+01)</td>
      <td> H-1</td>
      <td> scatter</td>
      <td> 0.373895</td>
      <td> 0.002964</td>
    </tr>
  </tbody>
</table>
</div></div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>


    <div class="footer" role="contentinfo">
        &copy; Copyright 2011-2015, Massachusetts Institute of Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.3.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30411614-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>